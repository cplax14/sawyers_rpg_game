# Tasks: Creature Breeding System Implementation

Based on PRD: `prd-breeding-system.md`

## Relevant Files

- `src/types/breeding.ts` - New type definitions for breeding system (BreedingRecipe, BreedingResult, BreedingCost, etc.)
- `src/types/creatures.ts` - Extend existing creature types with breeding metadata (generation, breedingCount, exhaustionLevel, inheritedAbilities, parentIds)
- `src/contexts/ReactGameContext.tsx` - Add breeding state and actions (breedingAttempts, discoveredRecipes)
- `src/utils/breedingEngine.ts` - Core breeding logic functions (NEW)
- `src/utils/breedingEngine.test.ts` - Unit tests for breeding engine
- `src/components/organisms/BreedingInterface.tsx` - Main breeding UI component (NEW)
- `src/components/organisms/BreedingInterface.test.tsx` - Unit tests for BreedingInterface
- `src/components/molecules/BreedingParentSelector.tsx` - Parent creature selection UI (NEW)
- `src/components/molecules/BreedingCostDisplay.tsx` - Cost and materials display (NEW)
- `src/components/molecules/BreedingResultModal.tsx` - Breeding results screen (NEW)
- `src/components/molecules/BreedingRecipeBook.tsx` - Recipe guide UI (NEW)
- `src/components/molecules/CreatureCard.tsx` - Update to show generation, exhaustion, breeding status
- `src/hooks/useBreeding.ts` - Custom hook for breeding operations (NEW)
- `src/hooks/useBreeding.test.ts` - Unit tests for useBreeding hook
- `public/data/breedingRecipes.js` - Breeding recipe data (10-15 common + 3-5 legendary) (NEW)
- `public/data/breedingMaterials.js` - Breeding materials data (NEW)
- `public/data/monsters.js` - Update monster data to support breeding materials drops (25-30% drop rates)
- `src/utils/creatureUtils.ts` - Add exhaustion management functions
- `src/utils/itemUtils.ts` - Add material validation and consumption functions

### Notes

- Unit tests should be placed alongside the code files they are testing.
- Use `npm test` to run all tests or `npm test [path/to/test/file]` for specific tests.

## Tasks

- [x] 1.0 Define Type System and Data Structures
  - [x] 1.1 Create `src/types/breeding.ts` with core breeding interfaces (BreedingRecipe, BreedingResult, BreedingCost, BreedingAttempt)
  - [x] 1.2 Define BreedingRecipe interface (parentSpecies1, parentSpecies2, materials, offspringSpecies, guaranteedBonuses)
  - [x] 1.3 Define BreedingResult interface (offspring creature, success flag, messages, inherited abilities)
  - [x] 1.4 Define BreedingCost interface (goldAmount, materials array with itemId and quantity)
  - [x] 1.5 Add Material interface for breeding materials (id, name, rarity, dropRate, icon)
  - [x] 1.6 Extend EnhancedCreature type in `src/types/creatures.ts` with breeding metadata
  - [x] 1.7 Add generation: number (0-5) to EnhancedCreature
  - [x] 1.8 Add breedingCount: number to track times creature has bred
  - [x] 1.9 Add exhaustionLevel: number to track exhaustion stacks
  - [x] 1.10 Add inheritedAbilities: string[] array of ability IDs
  - [x] 1.11 Add parentIds: [string?, string?] for lineage tracking
  - [x] 1.12 Add statCaps: Partial<PlayerStats> for generation-based max stats
  - [x] 1.13 Create BreedingState interface (activeBreeding, discoveredRecipes, breedingAttempts, materials)

- [x] 2.0 Extend Game State and Context for Breeding
  - [x] 2.1 Add breedingAttempts: number to ReactGameState (session counter for cost escalation)
  - [x] 2.2 Add discoveredRecipes: string[] to track unlocked breeding recipes
  - [x] 2.3 Add breedingMaterials: Record<string, number> to track available materials inventory
  - [x] 2.4 Create BREED_CREATURES action type in ReactGameAction
  - [x] 2.5 Create UPDATE_BREEDING_ATTEMPTS action type
  - [x] 2.6 Create DISCOVER_RECIPE action type
  - [x] 2.7 Create ADD_BREEDING_MATERIAL action type
  - [x] 2.8 Create REMOVE_BREEDING_MATERIAL action type
  - [x] 2.9 Create APPLY_EXHAUSTION action type
  - [x] 2.10 Implement reducer handlers for all breeding actions in reactGameReducer
  - [x] 2.11 Add breedCreatures() helper function to ReactGameContextType
  - [x] 2.12 Add applyExhaustion() helper function to ReactGameContextType
  - [x] 2.13 Add discoverRecipe() helper function to ReactGameContextType
  - [x] 2.14 Export breeding helper functions from context

- [x] 3.0 Implement Core Breeding Engine Logic
  - [x] 3.1 Create `src/utils/breedingEngine.ts` file
  - [x] 3.2 Implement calculateBreedingCost(parent1, parent2, attemptCount) function
  - [x] 3.3 Calculate base gold cost: 100 Ã— (parent1.level + parent2.level)
  - [x] 3.4 Apply rarity multiplier (Common Ã—1, Uncommon Ã—2, Rare Ã—4, Epic Ã—8, Legendary Ã—16)
  - [x] 3.5 Apply generation tax: Ã—1.5 per generation level
  - [x] 3.6 Apply per-creature breeding count tax: Ã—1.2 per breedingCount on each parent
  - [x] 3.7 Implement generateOffspring(parent1, parent2, recipe?) function
  - [x] 3.8 Determine offspring species (50/50 from parents or recipe-specific)
  - [x] 3.9 Call inheritStats() to calculate offspring base stats
  - [x] 3.10 Call rollRarityUpgrade() for 10% rarity upgrade chance
  - [x] 3.11 Determine generation: max(parent1.gen, parent2.gen) + 1 (cap at 5)
  - [x] 3.12 Call inheritAbilities() for 30% chance per parent ability
  - [x] 3.13 Set parentIds to track lineage
  - [x] 3.14 Return BreedingResult with new creature and metadata
  - [x] 3.15 Implement inheritStats(parent1Stats, parent2Stats, generation) function
  - [x] 3.16 Calculate base stats: random 70-90% of parent average for each stat
  - [x] 3.17 For each stat, 40% chance to inherit better parent's value
  - [x] 3.18 Apply generation bonus: +5% per generation (max +25% at Gen 5)
  - [x] 3.19 Return final stat object
  - [x] 3.20 Implement rollRarityUpgrade(parentRarity) function with 10% chance logic
  - [x] 3.21 Implement applyExhaustion(creature) function
  - [x] 3.22 Increment creature.breedingCount
  - [x] 3.23 Increment creature.exhaustionLevel
  - [x] 3.24 Apply -20% stat penalty per exhaustion level to currentStats
  - [x] 3.25 Return updated creature with exhaustion applied
  - [x] 3.26 Implement inheritAbilities(parent1, parent2) function
  - [x] 3.27 Roll 30% chance for each parent's abilities
  - [x] 3.28 Return array of inherited ability IDs
  - [x] 3.29 Implement calculateStatCaps(generation) function
  - [x] 3.30 Return stat caps with +10% per generation bonus

- [x] 4.0 Create Breeding Recipe and Material Data
  - [x] 4.1 Create `public/data/breedingRecipes.js` file
  - [x] 4.2 Define BreedingRecipeData array structure
  - [x] 4.3 Create 10-15 common breeding recipes (basic combinations, gold only)
  - [x] 4.4 Example: Slime + Slime = Slime (improved stats)
  - [x] 4.5 Example: Goblin + Wolf = Hobgoblin (hybrid species)
  - [x] 4.6 Example: Elemental + Beast = Elemental Beast
  - [x] 4.7 Create 3-5 legendary recipes (rare creatures + materials)
  - [x] 4.8 Example: Dragon + Phoenix + Dragon Scale = Ancient Dragon
  - [x] 4.9 Example: Demon + Angel + Holy Relic = Nephilim
  - [x] 4.10 Add recipe metadata (id, description, requiredMaterials, guaranteedBonuses)
  - [x] 4.11 Create `public/data/breedingMaterials.js` file
  - [x] 4.12 Define common materials (Slime Gel, Goblin Tooth, Wolf Pelt, Feathers, Scales)
  - [x] 4.13 Define rare materials (Dragon Scale, Phoenix Feather, Holy Relic, Demon Horn, Elemental Core)
  - [x] 4.14 Set material properties (id, name, rarity, description, icon, value)
  - [x] 4.15 Export recipe and material data for use in React components

- [x] 5.0 Update Monster Data for Breeding Materials
  - [x] 5.1 Open `public/data/monsters.js`
  - [x] 5.2 Add breedingMaterialDrops array to monster definitions
  - [x] 5.3 Set 25-30% drop rate for common materials (Slime â†’ Slime Gel)
  - [x] 5.4 Set 25-30% drop rate for rare materials from specific enemies
  - [x] 5.5 Add material drops to Slime: Slime Gel (30%)
  - [x] 5.6 Add material drops to Goblin: Goblin Tooth (28%), Leather Scraps (25%)
  - [x] 5.7 Add material drops to Wolf: Wolf Pelt (27%), Wolf Fang (30%)
  - [x] 5.8 Add material drops to Dragon: Dragon Scale (25%), Dragon Fang (20%)
  - [x] 5.9 Add material drops to Phoenix: Phoenix Feather (28%)
  - [x] 5.10 Add material drops to higher-level enemies: rare materials (25-30%)
  - [x] 5.11 Update combat reward generation in ReactGameContext to include materials
  - [x] 5.12 Test material drops in combat encounters

- [x] 6.0 Build Breeding UI Components
  - [x] 6.1 Create `src/components/organisms/BreedingInterface.tsx`
  - [x] 6.2 Set up component structure with state management (selectedParent1, selectedParent2, activeView)
  - [x] 6.3 Add view tabs: "Breed", "Recipe Guide", "History"
  - [x] 6.4 Integrate BreedingParentSelector for parent1 slot
  - [x] 6.5 Integrate BreedingParentSelector for parent2 slot
  - [x] 6.6 Display predicted offspring preview (stats, rarity, generation)
  - [x] 6.7 Integrate BreedingCostDisplay component
  - [x] 6.8 Add "Breed" button with validation (sufficient gold, materials, parents selected)
  - [x] 6.9 Show confirmation modal before breeding with summary
  - [x] 6.10 Trigger breeding action on confirm
  - [x] 6.11 Show BreedingResultModal on successful breeding
  - [x] 6.12 Add error handling and user-friendly error messages
  - [x] 6.13 Create `src/components/molecules/BreedingParentSelector.tsx`
  - [x] 6.14 Display creature selection slot (drag-and-drop or click to select)
  - [x] 6.15 Show list/grid of available creatures for selection
  - [x] 6.16 Display selected creature card with stats, generation, exhaustion indicator
  - [x] 6.17 Add creature filtering (by species, rarity, level)
  - [x] 6.18 Use LazyVirtualizedGrid for large creature lists
  - [x] 6.19 Create `src/components/molecules/BreedingCostDisplay.tsx`
  - [x] 6.20 Display calculated gold cost with breakdown (base, rarity, generation, breeding count)
  - [x] 6.21 Display required materials with icons and quantities
  - [x] 6.22 Highlight available vs missing materials (green/red indicators)
  - [x] 6.23 Show player's current gold and material inventory
  - [x] 6.24 Create `src/components/molecules/BreedingResultModal.tsx`
  - [x] 6.25 Display new offspring creature card with full stats
  - [x] 6.26 Show generation level with badge
  - [x] 6.27 Display inherited abilities (if any) with descriptions
  - [x] 6.28 Show rarity with visual celebration if upgraded
  - [x] 6.29 Add "Name Creature" input field
  - [x] 6.30 Add "View in Collection" button
  - [x] 6.31 Add "Breed Again" button
  - [x] 6.32 Create `src/components/molecules/BreedingRecipeBook.tsx`
  - [x] 6.33 Display discovered recipes with parent combinations and offspring
  - [x] 6.34 Show material requirements for each recipe
  - [x] 6.35 Display ??? for undiscovered recipes with hints
  - [x] 6.36 Add recipe search/filter functionality
  - [x] 6.37 Show recipe unlock conditions (level, story progression)

- [x] 7.0 Implement Breeding Cost and Economy System
  - [x] 7.1 Create validateBreedingCost(cost, playerGold, playerMaterials) utility function
  - [x] 7.2 Check if player has sufficient gold
  - [x] 7.3 Check if player has all required materials with correct quantities
  - [x] 7.4 Return validation result with specific missing resources
  - [x] 7.5 Enhanced validateBreeding() to include cost validation (replaces consumeBreedingCost)
  - [x] 7.6 Gold validation integrated in validateBreeding()
  - [x] 7.7 Material validation integrated in validateBreeding()
  - [x] 7.8 State updates handled by ReactGameContext BREED_CREATURES action (already implemented)
  - [x] 7.9 Add material management functions to itemUtils.ts
  - [x] 7.10 Implement addMaterial(materialId, quantity) function
  - [x] 7.11 Implement removeMaterial(materialId, quantity) function
  - [x] 7.12 Implement getMaterialQuantity(materialId) function
  - [x] 7.13 Integrate cost validation in breeding UI before allowing breeding (BreedingInterface.tsx)
  - [x] 7.14 Show cost breakdown tooltip (BreedingCostDisplay component already has this)

- [ ] 8.0 Add Exhaustion and Recovery Mechanics
  - [ ] 8.1 Update CreatureCard component to display exhaustion indicator
  - [ ] 8.2 Show exhaustion debuff icon (grayed out, with stack count)
  - [ ] 8.3 Display stat penalties in creature details (-20% per level)
  - [ ] 8.4 Create exhaustion recovery items in items.js
  - [ ] 8.5 Add "Revitalization Potion" (restores 1 exhaustion level, uncommon rarity)
  - [ ] 8.6 Add "Full Restore" (removes all exhaustion, rare rarity)
  - [ ] 8.7 Implement removeExhaustion(creature, levels) utility function
  - [ ] 8.8 Remove exhaustion levels from creature
  - [ ] 8.9 Recalculate stats without exhaustion penalties
  - [ ] 8.10 Create rest mechanic system (optional implementation)
  - [ ] 8.11 Add REST_CREATURE action to game context
  - [ ] 8.12 Reduce exhaustion over time (e.g., 1 level per 30 minutes in-game or real-time)
  - [ ] 8.13 Create gold-based instant recovery option
  - [ ] 8.14 Add "Remove Exhaustion" button in creature details (costs gold)
  - [ ] 8.15 Calculate recovery cost based on exhaustion level (e.g., 100 gold Ã— exhaustion level)

- [ ] 9.0 Implement Offspring Generation and Stat Inheritance
  - [ ] 9.1 Enhance generateOffspring() to support all inheritance rules
  - [ ] 9.2 Implement species determination logic (50/50 or recipe-based)
  - [ ] 9.3 Call inheritStats() with proper generation calculation
  - [ ] 9.4 Set offspring level to 1 (newborn creature)
  - [ ] 9.5 Set offspring HP/MP to max for level 1
  - [ ] 9.6 Copy base species abilities to offspring
  - [ ] 9.7 Add inherited abilities from inheritAbilities() function
  - [ ] 9.8 Set generation metadata (generation, parentIds)
  - [ ] 9.9 Initialize breedingCount to 0
  - [ ] 9.10 Initialize exhaustionLevel to 0
  - [ ] 9.11 Set stat caps based on generation using calculateStatCaps()
  - [ ] 9.12 Add createdAt timestamp
  - [ ] 9.13 Set isWild to false (bred creatures are not wild)
  - [ ] 9.14 Validate all offspring stats are within generation caps
  - [ ] 9.15 Add offspring to creature collection via context action

- [ ] 10.0 Add Rarity Upgrade and Special Abilities System
  - [ ] 10.1 Implement Mythic rarity tier in CreatureRarity type
  - [ ] 10.2 Update rollRarityUpgrade() to support Legendary â†’ Mythic (10%)
  - [ ] 10.3 Define Mythic tier stat bonuses (+50% compared to Legendary)
  - [ ] 10.4 Create Mythic ultimate abilities in abilities data
  - [ ] 10.5 Add visual effects for Mythic creatures (particle effects, aura)
  - [ ] 10.6 Implement generation-based ability slot unlocks
  - [ ] 10.7 Gen 2: +1 bonus ability slot
  - [ ] 10.8 Gen 3: +2 bonus ability slots + 1 passive trait slot
  - [ ] 10.9 Gen 4: +3 bonus ability slots + 2 passive trait slots
  - [ ] 10.10 Gen 5: +4 bonus ability slots + 3 passive trait slots + ultimate ability
  - [ ] 10.11 Create ability selection modal for inheritance conflicts
  - [ ] 10.12 Show inherited abilities, natural abilities, and total available slots
  - [ ] 10.13 Allow player to choose which abilities to keep
  - [ ] 10.14 Save ability selection to creature data
  - [ ] 10.15 Add passive trait system (new feature for Gen 3+)
  - [ ] 10.16 Define passive traits (stat boosts, special effects, resistances)
  - [ ] 10.17 Create Gen 5 ultimate abilities (unique, powerful, Mythic-exclusive)

- [ ] 11.0 Create Recipe Discovery and Breeding Guide
  - [ ] 11.1 Implement automatic recipe reveal when player obtains required creatures
  - [ ] 11.2 Check creature collection on capture/breeding
  - [ ] 11.3 Compare against recipe requirements
  - [ ] 11.4 Dispatch DISCOVER_RECIPE action if requirements met
  - [ ] 11.5 Show notification for newly discovered recipe
  - [ ] 11.6 Implement story progression-based recipe unlocks
  - [ ] 11.7 Link legendary recipes to story flags (boss defeats, area unlocks)
  - [ ] 11.8 Create NPC system for recipe hints
  - [ ] 11.9 Add "Breeding Master" NPC character data
  - [ ] 11.10 Implement purchasable recipe hints (gold cost)
  - [ ] 11.11 Create hint text for undiscovered recipes (vague clues)
  - [ ] 11.12 Update BreedingRecipeBook component with discovery status
  - [ ] 11.13 Show discovered recipes with full details
  - [ ] 11.14 Show undiscovered recipes as ??? with hints (if purchased)
  - [ ] 11.15 Add recipe completion percentage tracker

- [ ] 12.0 Add Visual Indicators for Bred Creatures
  - [ ] 12.1 Update CreatureCard component to show generation badge
  - [ ] 12.2 Display "Gen 1", "Gen 2", etc. badge in top-right corner
  - [ ] 12.3 Use different badge colors per generation (Gen 1: bronze, Gen 2: silver, Gen 3: gold, Gen 4: platinum, Gen 5: rainbow)
  - [ ] 12.4 Add special border color for bred creatures
  - [ ] 12.5 Use gold/silver gradient border for Gen 1-2
  - [ ] 12.6 Use platinum/rainbow gradient for Gen 3-5
  - [ ] 12.7 Add "bred" icon indicator (ðŸ§¬ DNA icon)
  - [ ] 12.8 Place icon in corner of creature card
  - [ ] 12.9 Increase visual prominence with generation level (larger icon, glowing effect)
  - [ ] 12.10 Add lineage view showing parent creatures
  - [ ] 12.11 Display parent1 and parent2 mini-cards
  - [ ] 12.12 Show lineage tree for Gen 3+ creatures
  - [ ] 12.13 Add special visual effects for Mythic creatures
  - [ ] 12.14 Particle effects around card (golden sparkles)
  - [ ] 12.15 Animated aura/glow effect
  - [ ] 12.16 Update creature list filters to include "Bred Only" toggle

- [ ] 13.0 Implement Save/Load for Breeding Data
  - [ ] 13.1 Extend save data schema to include breeding state
  - [ ] 13.2 Add breedingAttempts to save data
  - [ ] 13.3 Add discoveredRecipes array to save data
  - [ ] 13.4 Add breedingMaterials inventory to save data
  - [ ] 13.5 Extend creature save data with breeding metadata
  - [ ] 13.6 Save generation, breedingCount, exhaustionLevel, parentIds, inheritedAbilities
  - [ ] 13.7 Implement validation for loaded breeding data
  - [ ] 13.8 Validate generation values (0-5)
  - [ ] 13.9 Validate stat caps based on generation
  - [ ] 13.10 Validate inherited abilities exist and are valid
  - [ ] 13.11 Validate parentIds reference valid creatures or are null
  - [ ] 13.12 Add migration logic for old saves without breeding data
  - [ ] 13.13 Set default values (generation: 0, breedingCount: 0, exhaustionLevel: 0)
  - [ ] 13.14 Test save/load cycle with bred creatures
  - [ ] 13.15 Test cloud save compatibility with breeding data

- [ ] 14.0 Write Comprehensive Tests
  - [ ] 14.1 Create `src/utils/breedingEngine.test.ts`
  - [ ] 14.2 Test calculateBreedingCost() with various parent combinations
  - [ ] 14.3 Test cost escalation based on breeding count
  - [ ] 14.4 Test generation tax application
  - [ ] 14.5 Test inheritStats() stat calculation and randomness
  - [ ] 14.6 Test 40% inheritance chance for better parent stats
  - [ ] 14.7 Test generation bonuses (+5% per gen)
  - [ ] 14.8 Test rollRarityUpgrade() probability (10% chance)
  - [ ] 14.9 Test Legendary â†’ Mythic upgrade
  - [ ] 14.10 Test generateOffspring() with basic parents
  - [ ] 14.11 Test generateOffspring() with recipe
  - [ ] 14.12 Test species determination (50/50 vs recipe)
  - [ ] 14.13 Test applyExhaustion() stat penalties
  - [ ] 14.14 Test exhaustion stacking
  - [ ] 14.15 Create `src/hooks/useBreeding.test.ts`
  - [ ] 14.16 Test breeding workflow (select parents, validate, breed, receive offspring)
  - [ ] 14.17 Test cost validation (insufficient gold, missing materials)
  - [ ] 14.18 Test recipe discovery on creature acquisition
  - [ ] 14.19 Create `src/components/organisms/BreedingInterface.test.tsx`
  - [ ] 14.20 Test parent selection UI interaction
  - [ ] 14.21 Test cost display updates on parent change
  - [ ] 14.22 Test breeding button disabled when invalid
  - [ ] 14.23 Test confirmation modal display
  - [ ] 14.24 Test result modal with offspring data
  - [ ] 14.25 Test edge cases (Gen 5 max, Mythic rarity, ability conflicts)

- [ ] 15.0 Polish and Final Integration
  - [ ] 15.1 Add breeding tutorial/help tooltip to breeding interface
  - [ ] 15.2 Explain generation system, stat inheritance, costs
  - [ ] 15.3 Add tooltips for exhaustion, rarity upgrades, abilities
  - [ ] 15.4 Implement animations for breeding process
  - [ ] 15.5 Loading animation during offspring generation
  - [ ] 15.6 Celebration animation for rarity upgrade
  - [ ] 15.7 Particle effects for successful breeding
  - [ ] 15.8 Add sound effects (optional, if sound system exists)
  - [ ] 15.9 Breeding success sound, rarity upgrade fanfare
  - [ ] 15.10 Polish responsive design for mobile
  - [ ] 15.11 Test breeding UI on mobile viewports
  - [ ] 15.12 Ensure drag-and-drop works or fallback to tap selection
  - [ ] 15.13 Add accessibility features
  - [ ] 15.14 Keyboard navigation for breeding interface
  - [ ] 15.15 Screen reader support for stats and breeding results
  - [ ] 15.16 Color-blind friendly rarity indicators
  - [ ] 15.17 Integrate breeding into main game flow
  - [ ] 15.18 Add "Breeding" tab to CreatureScreen navigation
  - [ ] 15.19 Update main menu to highlight breeding feature
  - [ ] 15.20 Add breeding milestone achievements (first breed, Gen 5 creature, Mythic creature)
  - [ ] 15.21 Final end-to-end testing
  - [ ] 15.22 Test complete breeding workflow from creature capture to Gen 5
  - [ ] 15.23 Verify endgame balance (Gen 4/5 creatures vs. hardest bosses)
  - [ ] 15.24 Test material economy (drop rates, consumption rates)
  - [ ] 15.25 Code review and refactoring
  - [ ] 15.26 Optimize performance (memoization, lazy loading)
  - [ ] 15.27 Clean up console logs and debug code
  - [ ] 15.28 Update documentation (CLAUDE.md, inline comments)
